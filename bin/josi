#! /usr/bin/env node

var name = 'Josi';
var version = '0.1';
var author = 'Matt Lee - @thatismatt';

var fs = require('fs');
var sys = require('sys');
var path = require('path');

try {
  var tasks = require('josi/tasks').tasks;
}
catch(err) {
  // if that isn't on the path then assume the script being run is
  // in the source, so add the directory of the script to the path.
  if(err.message == "Cannot find module 'josi/tasks'") {
    require.paths.push(path.normalize(path.dirname(__filename) + '/..'));
    var tasks = require('josi/tasks').tasks;
  }
}

var utilities = require('josi/utilities');

var cwdContainsApp = function() {
  return utilities.fileOrDirectoryExists(path.join(process.cwd(), 'app.js'));
};

var getAllMatchingTasks = function(name) {
  var r = new RegExp('^' + name);
  return tasks
    .filter(function(t) {
      return r.test(t.name);
    });
};

var getFirstMatchingTask = function(t) {
  return getAllMatchingTasks(t)[0];
};

var processedArgs = utilities.processARGV(process.argv);

var task = processedArgs.task;
var opts = processedArgs.opts || {};

if (cwdContainsApp()) {
  var matchingTasks = getAllMatchingTasks(task);

  if (matchingTasks.length == 1) {
    matchingTasks[0].execute(opts);
  } else if (matchingTasks.length > 1) {
    sys.puts('"' + task + '" is not a Josi command, did you mean one of these?');
    matchingTasks.forEach(function(t) {
      sys.puts('\t' + t.name);
    });
  } else {
    getFirstMatchingTask('help').execute(opts);
  }
} else {
  if (task) {
    opts.name = task;
    getFirstMatchingTask('new').execute(opts);
  } else {
    sys.puts('ERROR: Directory does not contain a Josi app.')
  }
}
